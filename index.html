<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ù…ÙˆÙ„Ø¯Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: 'Cairo', sans-serif;
    direction: rtl;
    margin: 0;
    padding-bottom: 70px;
    background: linear-gradient(to bottom, #e0f7fa, #ffffff);
  }
  section {
    display: none;
    max-width: 95%;
    margin: 20px auto;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
  }
  button {
    background-color: #00bcd4;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    margin: 5px;
  }
  form input, input {
    margin-bottom: 12px;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 100%;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: #222;
    display: none;
    justify-content: space-around;
    align-items: center;
    z-index: 999;
  }
  nav button {
    background: none;
    border: none;
    color: #aaa;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  nav button.active {
    color: #00bcd4;
    font-weight: bold;
  }
  .login-container, .guide-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 30px;
    text-align: center;
    max-width: 400px;
    margin: 60px auto;
  }
  .guide-nav {
    display: flex;
    justify-content: space-between;
  }
</style>
</head>
<body>

<!-- ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø«Ù„Ø§Ø«Ø© -->
<section id="guide1" style="display:block;">
  <div class="guide-container">
    <h2>Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
    <p>ØªØ·Ø¨ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆÙ„Ø¯ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ù…Ù† Ø®Ù„Ø§Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.</p>
    <div class="guide-nav">
      <div></div>
      <button onclick="goToGuide(2)">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
    </div>
  </div>
</section>

<section id="guide2">
  <div class="guide-container">
    <h2>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²</h2>
    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø£Ùˆ Ø¹Ø¨Ø± Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©.</p>
    <div class="guide-nav">
      <button onclick="goToGuide(1)">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button onclick="goToGuide(3)">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
    </div>
  </div>
</section>

<section id="guide3">
  <div class="guide-container">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©</h2>
    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†ØŒ ØªØªØ¨Ø¹ Ø§Ù„Ø¯ÙØ¹ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.</p>
    <div class="guide-nav" style="justify-content: center;">
      <button onclick="goToGuide(2)">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    </div>
    <button onclick="goToLogin()" style="margin-top:20px;">ğŸš€ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
  </div>
</section>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² -->
<section id="codeLogin">
  <div class="login-container">
    <h1>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ù…ÙˆÙ„Ø¯Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
    <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</p>
    <input id="codeInput" type="text" placeholder="ğŸ” Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" />
    <button onclick="verifyCode()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <p id="codeError" style="color:red; display:none;">âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­</p>
  </div>
</section>

<!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© -->
<section id="ownerLogin">
  <div class="login-container">
    <h1>ğŸ‘¤ Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©</h1>
    <input id="ownerNameInput" type="text" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…" />
    <button onclick="saveOwnerName()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</section>

<!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø§Øª: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<section id="dashboard"><h2>ğŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2><div id="customerList"></div></section>
<section id="addCustomer"><h2>â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†</h2><form id="addForm"><input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" required><input type="text" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" required><input type="number" placeholder="Ø§Ù„Ø£Ù…Ø¨ÙŠØ±Ø§Øª" required><input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" required><button type="submit">ğŸ’¾ Ø­ÙØ¸</button></form></section>
<section id="notifications"><h2>ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2><div id="notificationsContent"></div></section>
<section id="stats"><h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2><div style="max-width:300px;margin:auto;"><canvas id="pieChart"></canvas></div><p id="statsText" style="text-align:center;font-weight:bold;"></p></section>

<nav>
  <button class="active" data-target="dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <button data-target="addCustomer">Ø¥Ø¶Ø§ÙØ©</button>
  <button data-target="notifications">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
  <button data-target="stats">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
</nav>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCa7-yWkUwcC108-VlizT6TDR5gKhEG1B0",
  authDomain: "salm1995.firebaseapp.com",
  databaseURL: "https://salm1995-default-rtdb.firebaseio.com",
  projectId: "salm1995",
  storageBucket: "salm1995.appspot.com",
  messagingSenderId: "989814377294",
  appId: "1:989814377294:web:2bd165641354e74b38ac1f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const allowedCodes = ["Salm11", "Power22", "GenX33", "Volt44", "Amper55", "Watts66", "Motor77", "Diesel88", "Fuel99", "Engine01", "MegaW02", "GenZ03", "Power04", "Smart05", "Volt06", "Grid07", "Turbo08", "Elec09", "Plant10", "Light20"];

function goToGuide(n) {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById("guide" + n).style.display = "block";
}
function goToLogin() {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById("codeLogin").style.display = "block";
}
function verifyCode() {
  const code = document.getElementById("codeInput").value.trim();
  if (allowedCodes.includes(code)) {
    localStorage.setItem("accountCode", code);
    document.getElementById("codeLogin").style.display = "none";
    document.getElementById("ownerLogin").style.display = "block";
  } else {
    document.getElementById("codeError").style.display = "block";
  }
}
function saveOwnerName() {
  const name = document.getElementById("ownerNameInput").value.trim();
  if (name) {
    localStorage.setItem("ownerName", name);
    location.reload();
  }
}
function showMainApp() {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.querySelector("nav").style.display = "flex";
  document.getElementById("dashboard").style.display = "block";
  loadCustomers();
  loadStats();
  loadNotifications();
}
document.querySelectorAll("nav button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    document.getElementById(btn.dataset.target).style.display = "block";
  });
});
document.getElementById("addForm").addEventListener("submit", e => {
  e.preventDefault();
  const inputs = e.target.querySelectorAll("input");
  const customer = {
    name: inputs[0].value,
    phone: inputs[1].value,
    amper: +inputs[2].value,
    price: +inputs[3].value,
    paid: false,
    lastPaymentTime: Date.now()
  };
  const code = localStorage.getItem("accountCode");
  db.ref("customers/" + code).push(customer).then(() => {
    e.target.reset();
    loadCustomers();
    loadStats();
    loadNotifications();
  });
});

function loadCustomers() {
  const code = localStorage.getItem("accountCode");
  const container = document.getElementById("customerList");
  db.ref("customers/" + code).once("value").then(snap => {
    const data = snap.val() || {};
    container.innerHTML = "";
    if (Object.keys(data).length === 0) {
      container.innerHTML = `
        <p style="text-align:center; color:#777; margin-bottom: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
        <div style="text-align:center;">
          <button onclick="showAddCustomer()" style="background-color:#00bcd4; padding:10px 20px; border:none; border-radius:8px; color:#fff; font-weight:bold; cursor:pointer;">
            â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†
          </button>
        </div>`;
      return;
    }
    for (const key in data) {
      const c = data[key];
      const durationDays = Math.floor((Date.now() - c.lastPaymentTime) / (1000 * 60 * 60 * 24));
      const card = document.createElement("div");
      card.style = "border:1px solid #ccc; margin-bottom:12px; padding:10px; border-radius:8px; background:#fafafa; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;";
      card.innerHTML = `
        <div style="flex:2; min-width:150px;"><b>${c.name}</b><br><small>Ø§Ù„Ù‡Ø§ØªÙ: ${c.phone}</small></div>
        <div style="flex:1; min-width:80px;">Ø£Ù…Ø¨ÙŠØ±: ${c.amper}</div>
        <div style="flex:1; min-width:80px;">Ø§Ù„Ø³Ø¹Ø±: ${c.price}</div>
        <div style="flex:1; min-width:100px; color:${c.paid ? '#28a745' : '#dc3545'};">
          ${c.paid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' : `Ù„Ù… ÙŠØ¯ÙØ¹ Ù…Ù†Ø° ${durationDays} ÙŠÙˆÙ…`}
        </div>
        <div style="flex:1; min-width:80px; text-align:center;">
          <button ${c.paid ? 'disabled' : ''} onclick="markPaid('${key}')">Ø¯ÙØ¹</button>
        </div>`;
      container.appendChild(card);
    }
  });
}

function showAddCustomer() {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById("addCustomer").style.display = "block";
  document.querySelector("nav button").forEach(btn => btn.classList.remove("active"));
  document.querySelector('nav button[data-target="addCustomer"]').classList.add("active");
}

function markPaid(key) {
  db.ref("customers/" + localStorage.getItem("accountCode") + "/" + key)
    .update({ paid: true, lastPaymentTime: Date.now() })
    .then(() => {
      loadCustomers();
      loadStats();
      loadNotifications();
    });
}

function loadNotifications() {
  const code = localStorage.getItem("accountCode");
  const container = document.getElementById("notificationsContent");
  container.innerHTML = "";
  db.ref("customers/" + code).once("value").then(snap => {
    const data = snap.val() || {};
    const alerts = [];
    for (const k in data) {
      const c = data[k];
      const daysSince = Math.floor((Date.now() - c.lastPaymentTime) / (1000 * 60 * 60 * 24));
      if (!c.paid && daysSince > 29) {
        alerts.push(`<div>âš ï¸ Ø§Ù„Ø²Ø¨ÙˆÙ† <b>${c.name}</b> Ù„Ù… ÙŠØ¯ÙØ¹ Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 29 ÙŠÙˆÙ…Ù‹Ø§.</div>`);
      }
    }
    container.innerHTML = alerts.length ? alerts.join("") : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
  });
}

let pieChart;
function loadStats() {
  const code = localStorage.getItem("accountCode");
  db.ref("customers/" + code).once("value").then(snap => {
    const data = snap.val() || {};
    let paidCount = 0, unpaidCount = 0;
    for (const k in data) {
      if (data[k].paid) paidCount++;
      else unpaidCount++;
    }
    const total = paidCount + unpaidCount;
    const paidPercent = total ? Math.round((paidCount / total) * 100) : 0;
    const ctx = document.getElementById("pieChart").getContext("2d");
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["ØªÙ… Ø§Ù„Ø¯ÙØ¹", "Ù„Ù… ÙŠØ¯ÙØ¹"],
        datasets: [{
          data: [paidCount, unpaidCount],
          backgroundColor: ["#28a745", "#dc3545"]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom", labels: { font: { size: 14 } } }
        }
      }
    });
    document.getElementById("statsText").textContent = `Ù…Ø¯ÙÙˆØ¹: ${paidCount} (${paidPercent}%) / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹: ${unpaidCount} (${100 - paidPercent}%)`;
  });
}

window.onload = () => {
  const name = localStorage.getItem("ownerName");
  const code = localStorage.getItem("accountCode");
  if (allowedCodes.includes(code)) {
    if (name && name.length > 1) {
      showMainApp();
    } else {
      document.querySelectorAll("section").forEach(s => s.style.display = "none");
      document.getElementById("ownerLogin").style.display = "block";
    }
  }
};
</script>

</body>
</html>
